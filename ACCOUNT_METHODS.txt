"""Account Management Extensions - Add to database.py at the end"""

    # ========== MANAGED ACCOUNTS METHODS ==========
    
    def create_account(self, user_id, account_name, account_type="Individual", email="", phone="", note=""):
        """Create a new managed account"""
        conn = self.get_connection()
        cursor = conn.cursor()
        try:
            cursor.execute('''
                INSERT INTO managed_accounts 
                (user_id, account_name, account_type, email, phone, notes, color, icon, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            ''', (user_id, account_name, account_type, email, phone, note, "#3b82f6", "ðŸ‘¤"))
            conn.commit()
            return cursor.lastrowid
        except Exception as e:
            conn.close()
            return None
        finally:
            conn.close()

    def get_managed_accounts(self, user_id):
        """Get all managed accounts for user"""
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT * FROM managed_accounts 
            WHERE user_id = ? 
            ORDER BY created_at DESC
        ''', (user_id,))
        accounts = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return accounts

    def get_account(self, account_id, user_id):
        """Get specific account"""
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM managed_accounts WHERE id = ? AND user_id = ?', (account_id, user_id))
        result = cursor.fetchone()
        conn.close()
        return dict(result) if result else None

    def update_account(self, account_id, user_id, **kwargs):
        """Update account details"""
        conn = self.get_connection()
        cursor = conn.cursor()
        allowed_fields = ['account_name', 'account_type', 'email', 'phone', 'address', 'city', 'notes', 'color', 'icon']
        updates = {k: v for k, v in kwargs.items() if k in allowed_fields}
        
        if not updates:
            conn.close()
            return False
        
        set_clause = ', '.join([f'{k} = ?' for k in updates.keys()])
        values = list(updates.values()) + [account_id, user_id]
        
        try:
            cursor.execute(f'''
                UPDATE managed_accounts 
                SET {set_clause}, updated_at = CURRENT_TIMESTAMP
                WHERE id = ? AND user_id = ?
            ''', values)
            conn.commit()
            return True
        except:
            return False
        finally:
            conn.close()

    def delete_account(self, account_id, user_id):
        """Delete managed account and clean up transactions"""
        conn = self.get_connection()
        cursor = conn.cursor()
        try:
            # Delete account transactions
            cursor.execute('DELETE FROM expenses WHERE account_id = ? AND user_id = ?', (account_id, user_id))
            cursor.execute('DELETE FROM income WHERE account_id = ? AND user_id = ?', (account_id, user_id))
            # Delete account
            cursor.execute('DELETE FROM managed_accounts WHERE id = ? AND user_id = ?', (account_id, user_id))
            conn.commit()
            return True
        except:
            return False
        finally:
            conn.close()

    def add_expense_to_account(self, user_id, account_id, category, amount, date, description="", payment_method="", notes=""):
        """Add expense to specific account"""
        conn = self.get_connection()
        cursor = conn.cursor()
        try:
            cursor.execute('''
                INSERT INTO expenses 
                (user_id, account_id, category, amount, date, description, payment_method, notes, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            ''', (user_id, account_id, category, amount, date, description, payment_method, notes))
            conn.commit()
            return cursor.lastrowid
        except:
            return None
        finally:
            conn.close()

    def get_account_expenses(self, user_id, account_id, start_date=None, end_date=None):
        """Get expenses for specific account"""
        conn = self.get_connection()
        cursor = conn.cursor()
        if start_date and end_date:
            cursor.execute('''
                SELECT * FROM expenses 
                WHERE user_id = ? AND account_id = ? AND date BETWEEN ? AND ?
                ORDER BY date DESC
            ''', (user_id, account_id, start_date, end_date))
        else:
            cursor.execute('''
                SELECT * FROM expenses 
                WHERE user_id = ? AND account_id = ?
                ORDER BY date DESC
            ''', (user_id, account_id))
        expenses = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return expenses

    def get_account_summary(self, user_id, account_id):
        """Get financial summary for account"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # Total income
        cursor.execute('SELECT COALESCE(SUM(amount), 0) as total FROM income WHERE user_id = ? AND account_id = ?', 
                      (user_id, account_id))
        income = cursor.fetchone()['total']
        
        # Total expenses
        cursor.execute('SELECT COALESCE(SUM(amount), 0) as total FROM expenses WHERE user_id = ? AND account_id = ?',
                      (user_id, account_id))
        expenses = cursor.fetchone()['total']
        
        conn.close()
        return {
            'total_income': income,
            'total_expenses': expenses,
            'balance': income - expenses
        }

    def get_account_category_summary(self, user_id, account_id):
        """Get category breakdown for account"""
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT category, COUNT(*) as count, SUM(amount) as total
            FROM expenses 
            WHERE user_id = ? AND account_id = ?
            GROUP BY category 
            ORDER BY total DESC
        ''', (user_id, account_id))
        categories = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return categories
